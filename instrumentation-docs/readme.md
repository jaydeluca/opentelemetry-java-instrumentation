# Doc Generator

Runs analysis on instrumentation modules in order to generate documentation.

## How to use

Until this process is ready for all instrumentations, each module will be modified to include a
system property configured for when the tests run:

```kotlin
tasks {
  test {
    systemProperty("collectMetadata", findProperty("collectMetadata")?.toString() ?: "false")
    ...
  }
}
```

Prior to running the DocGeneratorApplication, run the following command to collect metadata:

* Run tests to collect metadata
  * `./gradlew test -collectMetadata=true`
* Run the doc generator
  * `./gradlew :instrumentation-docs`

## Instrumentation Hierarchy

An "InstrumentationEntity" represents a module that that targets specific code in a framework/library/technology.
Each instrumentation uses muzzle to determine which versions of the target code it supports.

Using these structures as examples:

```
├── instrumentation
│   ├── clickhouse-client-05
│   ├── jaxrs
│   │   ├── jaxrs-1.0
│   │   ├── jaxrs-2.0
│   ├── spring
│   │   ├── spring-cloud-gateway
│   │   │   ├── spring-cloud-gateway-2.0
│   │   │   ├── spring-cloud-gateway-2.2
│   │   │   └── spring-cloud-gateway-common
```

* Name
  * Ex: `clickhouse-client-05`, `jaxrs-1.0`, `spring-cloud-gateway-2.0`
* Namespace - direct parent. if none, use name and strip version
  * `clickhouse-client`, `jaxrs`, `spring-cloud-gateway`
* Group - top most parent
  * `clickhouse-client`, `jaxrs`, `spring`

This information is also referenced in `InstrumentationModule` code for each module:

```java
public class SpringWebInstrumentationModule extends InstrumentationModule
    implements ExperimentalInstrumentationModule {
  public SpringWebInstrumentationModule() {
    super("spring-web", "spring-web-3.1");
  }
```

## Instrumentation metadata

* name
  * Identifier for instrumentation module, used to enable/disable
  * Configured in `InstrumentationModule` code for each module
* srcPath
  * Path to the source code of the instrumentation module
* description
  * Short description of what the instrumentation does
* target_versions
  * List of supported versions by the module, broken down by `library` or `javaagent` support
* scope
  * The scope of the instrumentation, including the name, version, schemaUrl and attributes
* metrics
  * List of metrics that the instrumentation module collects, including the metric name, description, type, and attributes
* span_data
  * List of span data that the instrumentation collects, including the attribute name and type

## Methodology

### metadata.yaml file

Within each instrumentation source directory, a `metadata.yaml` file can be created to provide
additional information about the instrumentation module.

As of now, the following fields are supported:

```yaml
description: "Description of what the instrumentation does."
```

### Versions targeted

We parse gradle files in order to determine the target versions.

- Javaagent versions are determined by the `muzzle` plugin configurations
- Library versions are determined by the library dependency versions
  - when available, latestDepTestLibrary is used to determine the latest supported version

### Scope, Span Data, and Metrics

Since many of our tests generate this information, we can hook into the InstrumentationTestRunner
class and collect the metrics, spans, and scope generated. We can then leverage the `afterTestClass()`
in the Agent and library test runners to then write this information into temporary files.

The data is written into a `.telemetry` directory in the root of the instrumentation module. This data
will be excluded from git and just generated on demand.

Since metadata can be generated by multiple classes, we will generate a file per class.

Example output:

```
clickhouse:
  instrumentations:
  - name: clickhouse-client-0.5
    description: Instruments the V1 ClickHouseClient, providing database client spans
      and metrics.
    srcPath: instrumentation/clickhouse-client-0.5
    target_versions:
      javaagent:
      - com.clickhouse.client:clickhouse-client:[0.5.0,)
    metrics:
    - name: db.client.operation.duration
      description: Duration of database client operations.
      type: HISTOGRAM
      unit: s
      attributes:
      - name: db.namespace
        type: STRING
      - name: db.operation.name
        type: STRING
      - name: db.system.name
        type: STRING
      - name: server.address
        type: STRING
      - name: server.port
        type: LONG
    span_data:
      attributes:
      - name: server.address
        type: STRING
      - name: server.port
        type: LONG
      - name: db.system.name
        type: STRING
      - name: db.query.text
        type: STRING
      - name: db.namespace
        type: STRING
      - name: db.operation.name
        type: STRING
```
